<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aile Hekimliƒüi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f3b27">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --forest:#1f3b27;
  --forest2:#0b1f16;
  --panel:#2a4a33;
  --cream:#f5f1e8;
  --cream2:#efe6d8;
  --text:#0b1f16;
  --muted:#607066;
  --accent:#2e7d32;
  --accent2:#4caf50;
  --danger:#b23b3b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:linear-gradient(180deg,var(--forest),var(--forest2));
  color:#fff;
  padding:16px;
}
h1{margin:0 0 10px 0;font-size:22px}
.panel{
  background:var(--panel);
  border-radius:22px;
  padding:16px;
  margin:14px 0;
}
input,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:var(--cream);
  color:var(--text);
  margin:6px 0;
}
button{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  color:white;
  font-weight:800;
  cursor:pointer;
}
.tabbar{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
.tab{
  flex:1;
  padding:12px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  text-align:center;
  font-weight:700;
  cursor:pointer;
}
.tab.active{
  background:var(--cream);
  color:var(--text);
}
.cat-card{
  background:var(--cream2);
  color:var(--text);
  border-radius:18px;
  padding:14px;
  margin-top:10px;
  position:relative;
}
.remove{
  position:absolute;
  top:10px; right:12px;
  cursor:pointer;
  color:var(--danger);
  font-size:18px;
}
.list-card{
  background:var(--cream);
  color:var(--text);
  border-radius:20px;
  padding:14px;
  margin-top:12px;
}
.badge{
  display:inline-block;
  margin:4px 6px 0 0;
  padding:3px 10px;
  border-radius:999px;
  font-size:12px;
  background:rgba(46,125,50,.12);
  border:1px solid rgba(46,125,50,.35);
}
.small{font-size:12px;color:var(--muted)}
.btn-danger{
  background:transparent;
  color:var(--danger);
  border:1px solid var(--danger);
  padding:8px 12px;
  border-radius:999px;
  margin-top:8px;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc,
  query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhRWEiA-rrpuazR_YnV7UmhQ-UiDeAHUU",
  authDomain: "aile-hekimligi-paneli.firebaseapp.com",
  projectId: "aile-hekimligi-paneli"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const KATS=[
 "Hipertansiyon","DM","KVR","Obezite",
 "Ya≈ülƒ± ƒ∞zlem","KAH ƒ∞zlem","ƒ∞nme ƒ∞zlem",
 "KBH ƒ∞zlem","KOAH ƒ∞zlem","Astƒ±m ƒ∞zlem"
];
const ILK4=new Set(["Hipertansiyon","DM","KVR","Obezite"]);

let selected=[];
let ALL=[];

window.onload=()=>{
  katSec.innerHTML=`<option value="">Kategori se√ß</option>`+KATS.map(k=>`<option>${k}</option>`).join("");
  fkat.innerHTML=`<option value="">Kategori</option>`+KATS.map(k=>`<option>${k}</option>`).join("");
  load();
};

window.showTab=(id)=>{
  newTab.style.display=id==="new"?"block":"none";
  listTab.style.display=id==="list"?"block":"none";
  tNew.classList.toggle("active",id==="new");
  tList.classList.toggle("active",id==="list");
};

window.katEkle=()=>{
  if(!katSec.value||selected.some(x=>x.kategori===katSec.value))return;
  selected.push({kategori:katSec.value,alt:"",hyp:""});
  renderSel();
};

window.kaldir=i=>{selected.splice(i,1);renderSel();};

function renderSel(){
  cards.innerHTML="";
  selected.forEach((x,i)=>{
    cards.innerHTML+=`
    <div class="cat-card">
      <div class="remove" onclick="kaldir(${i})">üóëÔ∏è</div>
      <b>${x.kategori}</b>
      ${ILK4.has(x.kategori)?`
      <select onchange="selected[${i}].alt=this.value">
        <option value="">Tarama / ƒ∞zlem</option>
        <option>Tarama</option>
        <option>ƒ∞zlem</option>
      </select>`:""}
      <input placeholder="HYP tarihi" oninput="selected[${i}].hyp=this.value">
    </div>`;
  });
}

window.ekle=async()=>{
  if(!ad.value||!tc.value)return alert("Ad ve TC zorunlu");
  if(!selected.length)return alert("Kategori ekle");
  const kategoriler=selected.map(x=>({
    kategori:x.kategori,
    alt:ILK4.has(x.kategori)?(x.alt||"ƒ∞zlem"):"",
    hyp:x.hyp||""
  }));
  await addDoc(collection(db,"patients"),{
    ad:ad.value,tc:tc.value,kategoriler,createdAt:serverTimestamp()
  });
  ad.value="";tc.value="";selected=[];renderSel();
  await load();
  showTab("list");
};

async function load(){
  const q=query(collection(db,"patients"),orderBy("createdAt","desc"));
  const s=await getDocs(q);
  ALL=[];s.forEach(d=>ALL.push({...d.data(),id:d.id}));
  filtre();
}

window.filtre=()=>{
  const fk=fkat.value;
  list.innerHTML="";
  ALL.filter(r=>!fk||r.kategoriler.some(k=>k.kategori===fk))
  .forEach(r=>{
    list.innerHTML+=`
    <div class="list-card">
      <b>${r.ad}</b><br><span class="small">TC: ${r.tc}</span>
      <div>${r.kategoriler.map(k=>`<span class="badge">${k.kategori} ${k.alt||""} ${k.hyp||""}</span>`).join("")}</div>
      <button class="btn-danger" onclick="sil('${r.id}')">Sil</button>
    </div>`;
  });
};

window.sil=async id=>{
  if(confirm("Silinsin mi?")){
    await deleteDoc(doc(db,"patients",id));
    load();
  }
};
</script>
</head>

<body>
<h1>üå≤ Aile Hekimliƒüi</h1>

<div class="tabbar">
  <div id="tNew" class="tab active" onclick="showTab('new')">‚ûï Yeni Hasta</div>
  <div id="tList" class="tab" onclick="showTab('list')">üìã Hasta Listesi</div>
</div>

<div id="newTab">
  <div class="panel">
    <input id="ad" placeholder="Ad Soyad">
    <input id="tc" placeholder="TC">
    <select id="katSec"></select>
    <button onclick="katEkle()">+ Kategori Ekle</button>
    <div id="cards"></div>
    <button onclick="ekle()">Kaydet</button>
  </div>
</div>

<div id="listTab" style="display:none">
  <div class="panel">
    <select id="fkat" onchange="filtre()"></select>
    <div id="list">Y√ºkleniyor‚Ä¶</div>
  </div>
</div>

</body>
</html>
