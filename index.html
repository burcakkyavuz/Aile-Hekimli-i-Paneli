<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aile Hekimliƒüi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f3b27">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --bg:#1f3b27;
  --panel:#2a4a33;
  --card:#f5f1e8;
  --accent:#4caf50;
  --accent2:#2e7d32;
  --text:#0b1f16;
  --muted:#5f6f65;
  --danger:#b23b3b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:linear-gradient(180deg,#1f3b27,#0b1f16);
  color:white;
  padding:16px;
}
h1{margin:0 0 12px 0;font-size:22px}
.panel{
  background:var(--panel);
  border-radius:22px;
  padding:16px;
  margin:14px 0;
}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:140px}

input,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:var(--card);
  color:var(--text);
  margin:6px 0;
  font-size:15px;
}
button{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:white;
  font-weight:700;
  font-size:16px;
}
.cat-card{
  background:var(--card);
  color:var(--text);
  border-radius:18px;
  padding:14px;
  margin-top:10px;
  position:relative;
}
.cat-title{font-weight:700;margin-bottom:6px}
.remove{
  position:absolute;
  top:10px;right:12px;
  cursor:pointer;
  color:var(--danger);
  font-size:18px;
}
.card{
  background:var(--card);
  color:var(--text);
  border-radius:20px;
  padding:14px;
  margin-top:12px;
}
.small{font-size:12px;color:var(--muted)}
.btn-danger{
  background:transparent;
  color:var(--danger);
  border:1px solid var(--danger);
  padding:8px 12px;
  border-radius:999px;
  margin-top:8px;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhRWEiA-rrpuazR_YnV7UmhQ-UiDeAHUU",
  authDomain: "aile-hekimligi-paneli.firebaseapp.com",
  projectId: "aile-hekimligi-paneli"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const KATS=[
 "Hipertansiyon","DM","KVR","Obezite",
 "Ya≈ülƒ± ƒ∞zlem","KAH ƒ∞zlem","ƒ∞nme ƒ∞zlem",
 "KBH ƒ∞zlem","KOAH ƒ∞zlem","Astƒ±m ƒ∞zlem"
];
const ILK4=["Hipertansiyon","DM","KVR","Obezite"];

let eklenen=[]; // se√ßilen kategori kartlarƒ±
let ALL=[];

window.onload=()=>{
  const s=document.getElementById("katSec");
  KATS.forEach(k=>s.innerHTML+=`<option>${k}</option>`);
  load();
};

window.katEkle=()=>{
  const k=katSec.value;
  if(!k || eklenen.some(x=>x.kategori===k)) return;
  const obj={kategori:k,alt:"",hyp:""};
  eklenen.push(obj);
  renderCats();
};

function renderCats(){
  cards.innerHTML="";
  eklenen.forEach((x,i)=>{
    cards.innerHTML+=`
    <div class="cat-card">
      <div class="remove" onclick="kaldir(${i})">üóëÔ∏è</div>
      <div class="cat-title">${x.kategori}</div>
      ${ILK4.includes(x.kategori)?`
        <select onchange="eklenen[${i}].alt=this.value">
          <option value="">Tarama / ƒ∞zlem</option>
          <option>Tarama</option>
          <option>ƒ∞zlem</option>
        </select>`:""}
      <input placeholder="HYP tarihi" oninput="eklenen[${i}].hyp=this.value">
    </div>`;
  });
}
window.kaldir=i=>{eklenen.splice(i,1);renderCats();};

window.ekle=async ()=>{
  if(!ad.value||!tc.value) return alert("Ad ve TC zorunlu");
  if(!eklenen.length) return alert("Kategori ekle");
  for(const k of eklenen){
    if(ILK4.includes(k.kategori)&&!k.alt) return alert(k.kategori+" i√ßin Tarama/ƒ∞zlem");
  }
  await addDoc(collection(db,"patients"),{
    ad:ad.value, tc:tc.value,
    kategoriler:eklenen,
    createdAt:new Date()
  });
  eklenen=[];renderCats();load();
};

async function load(){
  const q=query(collection(db,"patients"),orderBy("createdAt","desc"));
  const s=await getDocs(q);
  ALL=[]; s.forEach(d=>ALL.push({...d.data(),id:d.id}));
  filtre();
}
window.filtre=()=>{
  const fa=fad.value.toLowerCase(), ft=ftc.value, fk=fkat.value;
  list.innerHTML="";
  ALL.filter(r=>
    (!fa||r.ad.toLowerCase().includes(fa)) &&
    (!ft||r.tc.includes(ft)) &&
    (!fk||r.kategoriler.some(x=>x.kategori===fk))
  ).forEach(r=>{
    list.innerHTML+=`
    <div class="card">
      <b>${r.ad}</b><br>
      <span class="small">TC: ${r.tc}</span>
      ${r.kategoriler.map(x=>`<div>‚Ä¢ ${x.kategori} ${x.alt||""} ${x.hyp||""}</div>`).join("")}
      <button class="btn-danger" onclick="sil('${r.id}')">Sil</button>
    </div>`;
  });
};
window.sil=async id=>{
  if(confirm("Silinsin mi?")){
    await deleteDoc(doc(db,"patients",id));load();
  }
};
</script>
</head>

<body>
<h1>üå≤ Aile Hekimliƒüi</h1>

<div class="panel">
  <div class="row">
    <div class="col"><input id="ad" placeholder="Ad Soyad"></div>
    <div class="col"><input id="tc" placeholder="TC"></div>
  </div>

  <div class="row">
    <div class="col">
      <select id="katSec"><option value="">Kategori se√ß</option></select>
    </div>
    <div class="col">
      <button onclick="katEkle()">+ Kategori Ekle</button>
    </div>
  </div>

  <div id="cards"></div>
  <button onclick="ekle()">Kaydet</button>
</div>

<div class="panel">
  <div class="row">
    <div class="col"><input id="fad" placeholder="ƒ∞sim filtre" oninput="filtre()"></div>
    <div class="col"><input id="ftc" placeholder="TC filtre" oninput="filtre()"></div>
    <div class="col">
      <select id="fkat" onchange="filtre()">
        <option value="">Kategori</option>
        ${KATS.map(k=>`<option>${k}</option>`).join("")}
      </select>
    </div>
  </div>
</div>

<div class="panel"><div id="list"></div></div>
</body>
</html>
