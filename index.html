<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aile HekimliÄŸi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f3b27">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --forest:#1f3b27; --forest2:#0b1f16; --panel:#2a4a33;
  --cream:#f5f1e8; --cream2:#efe6d8; --text:#0b1f16; --muted:#607066;
  --accent:#2e7d32; --accent2:#4caf50; --danger:#b23b3b;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui;background:linear-gradient(180deg,var(--forest),var(--forest2));color:#fff;padding:16px;}
  <div id="loginScreen" style="
  position:fixed;
  inset:0;
  background:linear-gradient(180deg,#1f3b27,#0b1f16);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:#f5f1e8;
    padding:24px;
    border-radius:20px;
    width:90%;
    max-width:320px;
    text-align:center;
  ">
    <h2 style="margin-top:0;color:#1f3b27">ğŸ”’ GiriÅŸ</h2>
    <input
      id="passwordInput"
      type="password"
      placeholder="Åifre"
      style="
        width:100%;
        padding:12px;
        border-radius:12px;
        border:none;
        margin-bottom:12px;
      "
    >
    <button onclick="checkPassword()">GiriÅŸ</button>
    <div id="loginError" style="
      color:#b23b3b;
      font-size:13px;
      margin-top:8px;
      display:none;
    ">
      Åifre yanlÄ±ÅŸ
    </div>
  </div>
</div>

h1{margin:0 0 10px 0;font-size:22px}
.panel{background:var(--panel);border-radius:22px;padding:16px;margin:14px 0;}
input,select{width:100%;padding:12px;border-radius:14px;border:none;background:var(--cream);color:var(--text);margin:6px 0;}
button{width:100%;padding:14px;border-radius:999px;border:none;background:linear-gradient(135deg,var(--accent2),var(--accent));color:white;font-weight:800;cursor:pointer;}
.tabbar{display:flex;gap:10px;margin-bottom:12px;}
.tab{flex:1;padding:12px;border-radius:999px;background:rgba(255,255,255,.12);text-align:center;font-weight:800;cursor:pointer;}
.tab.active{background:var(--cream);color:var(--text);}
.cat-card{background:var(--cream2);color:var(--text);border-radius:18px;padding:14px;margin-top:10px;position:relative;}
.remove{position:absolute;top:10px;right:12px;cursor:pointer;color:var(--danger);font-size:18px;user-select:none;}
.list-card{background:var(--cream);color:var(--text);border-radius:20px;padding:14px;margin-top:12px;}
.badge{display:inline-block;margin:4px 6px 0 0;padding:3px 10px;border-radius:999px;font-size:12px;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.35);}
.small{font-size:12px;color:var(--muted)}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger);padding:8px 12px;border-radius:999px;margin-top:8px;font-weight:800;}
.grid2{display:flex;gap:10px;flex-wrap:wrap}
.grid2 > div{flex:1;min-width:140px}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc,
  query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhRWEiA-rrpuazR_YnV7UmhQ-UiDeAHUU",
  authDomain: "aile-hekimligi-paneli.firebaseapp.com",
  projectId: "aile-hekimligi-paneli"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const KATS=[
 "Hipertansiyon","DM","KVR","Obezite",
 "YaÅŸlÄ± Ä°zlem","KAH Ä°zlem","Ä°nme Ä°zlem",
 "KBH Ä°zlem","KOAH Ä°zlem","AstÄ±m Ä°zlem"
];
const ILK4=new Set(["Hipertansiyon","DM","KVR","Obezite"]);

let selected=[]; // {kategori, alt, hyp}
let ALL=[];

const el = {};
function q(id){ return document.getElementById(id); }

function showTab(which){
  el.newTab.style.display = which==="new" ? "block" : "none";
  el.listTab.style.display = which==="list" ? "block" : "none";
  el.tNew.classList.toggle("active", which==="new");
  el.tList.classList.toggle("active", which==="list");
}

function buildSelectOptions(selectEl, firstText){
  selectEl.innerHTML = `<option value="">${firstText}</option>` + KATS.map(k=>`<option value="${k}">${k}</option>`).join("");
}

function renderSelected(){
  el.cards.innerHTML = "";
  if(!selected.length){
    el.cards.innerHTML = `<div class="small">Kategori seÃ§ip â€œ+ Kategori Ekleâ€ deyince kartlar burada Ã§Ä±kacak.</div>`;
    return;
  }

  selected.forEach((x,i)=>{
    const needsAlt = ILK4.has(x.kategori);
    const wrap = document.createElement("div");
    wrap.className = "cat-card";
    wrap.dataset.idx = String(i);

    const remove = document.createElement("div");
    remove.className = "remove";
    remove.textContent = "ğŸ—‘ï¸";
    remove.title = "KaldÄ±r";
    remove.onclick = ()=>{ selected.splice(i,1); renderSelected(); };
    wrap.appendChild(remove);

    const title = document.createElement("div");
    title.style.fontWeight="900";
    title.style.marginBottom="6px";
    title.textContent = x.kategori;
    wrap.appendChild(title);

    if(needsAlt){
      const sel = document.createElement("select");
      sel.innerHTML = `
        <option value="">Tarama / Ä°zlem</option>
        <option value="Tarama">Tarama</option>
        <option value="Ä°zlem">Ä°zlem</option>`;
      sel.value = x.alt || "";
      sel.onchange = (e)=>{ selected[i].alt = e.target.value; };
      wrap.appendChild(sel);
    }

    const hyp = document.createElement("input");
    hyp.placeholder = "HYP tarihi (Ã¶rn: 2025-02-11)";
    hyp.value = x.hyp || "";
    hyp.oninput = (e)=>{ selected[i].hyp = e.target.value; };
    wrap.appendChild(hyp);

    el.cards.appendChild(wrap);
  });
}

async function load(){
  const s = await getDocs(collection(db,"patients"));
  ALL = [];
  s.forEach(d=>{
    ALL.push({ id:d.id, ...d.data() });
  });
  filterList();
}

function filterList(){
  const nameQ = (el.fad.value||"").trim().toLowerCase();
  const tcQ = (el.ftc.value||"").trim();
  const fk = (el.fkat.value||"").trim();

  const filtered = ALL.filter(r=>{
    const okName = !nameQ || (r.ad||"").toLowerCase().includes(nameQ);
    const okTc = !tcQ || (r.tc||"").includes(tcQ);
    const okKat = !fk || (r.kategoriler||[]).some(k=>k.kategori===fk);
    return okName && okTc && okKat;
  });

  el.list.innerHTML = "";
  if(!filtered.length){
    el.list.innerHTML = `<div class="small">KayÄ±t yok / filtreye uyan yok.</div>`;
    return;
  }

  filtered.forEach(r=>{
    const div = document.createElement("div");
    div.className = "list-card";

    div.innerHTML = `
      <div style="font-weight:900;font-size:16px">${r.ad||""}</div>
      <div class="small">TC: ${r.tc||""}</div>
      <div style="margin-top:8px">
        ${(r.kategoriler||[]).map(k=>{
          const alt = k.alt ? ` â€¢ ${k.alt}` : "";
          const hyp = k.hyp ? ` â€¢ ${k.hyp}` : "";
          return `<span class="badge">${k.kategori}${alt}${hyp}</span>`;
        }).join("")}
      </div>
    `;

    const btn = document.createElement("button");
    btn.className = "btn-danger";
    btn.textContent = "Sil";
    btn.onclick = async ()=>{
      if(!confirm("Silinsin mi?")) return;
      await deleteDoc(doc(db,"patients", r.id));
      await load();
    };
    div.appendChild(btn);

    el.list.appendChild(div);
  });
}

async function savePatient(){
  const ad = el.ad.value.trim();
  const tc = el.tc.value.trim();
  if(!ad || !tc) return alert("Ad ve TC zorunlu.");
  if(!selected.length) return alert("En az 1 kategori eklemelisin.");

  const kategoriler = selected.map(x=>({
    kategori: x.kategori,
    alt: ILK4.has(x.kategori) ? (x.alt || "Ä°zlem") : "",
    hyp: (x.hyp || "").trim()
  }));

  const nowMs = Date.now();

  await addDoc(collection(db,"patients"),{
    ad, tc,
    kategoriler,
    createdAt: serverTimestamp(),
    createdAtMs: nowMs
  });

  // temizle + listeye geÃ§
  el.ad.value=""; el.tc.value=""; el.katSec.value="";
  selected.length = 0;
  renderSelected();

  await load();
  showTab("list");
}

function addCategory(){
  const k = el.katSec.value;
  if(!k) return;
  if(selected.some(x=>x.kategori===k)) return;
  selected.push({kategori:k, alt:"", hyp:""});
  renderSelected();
}

window.addEventListener("load", async ()=>{
  // element refs
  ["tNew","tList","newTab","listTab","ad","tc","katSec","cards","saveBtn",
   "fad","ftc","fkat","list","clearBtn","refreshBtn","addCatBtn"].forEach(id=>el[id]=q(id));

  buildSelectOptions(el.katSec, "Kategori seÃ§");
  buildSelectOptions(el.fkat, "Kategori (filtre)");

  el.tNew.onclick = ()=>showTab("new");
  el.tList.onclick = ()=>showTab("list");
  el.addCatBtn.onclick = addCategory;
  el.saveBtn.onclick = savePatient;

  el.fad.oninput = filterList;
  el.ftc.oninput = filterList;
  el.fkat.onchange = filterList;

  el.clearBtn.onclick = ()=>{
    el.fad.value=""; el.ftc.value=""; el.fkat.value="";
    filterList();
  };
  el.refreshBtn.onclick = load;

  renderSelected();
  await load();
});
</script>
</head>

<body>
<h1>ğŸŒ² Aile HekimliÄŸi</h1>

<div class="tabbar">
  <div id="tNew" class="tab active">â• Yeni Hasta</div>
  <div id="tList" class="tab">ğŸ“‹ Hasta Listesi</div>
</div>

<div id="newTab">
  <div class="panel">
    <div class="grid2">
      <div><input id="ad" placeholder="Ad Soyad"></div>
      <div><input id="tc" placeholder="TC"></div>
    </div>

    <div class="grid2">
      <div><select id="katSec"></select></div>
      <div><button id="addCatBtn" type="button">+ Kategori Ekle</button></div>
    </div>

    <div id="cards"></div>

    <button id="saveBtn" type="button">Kaydet</button>
    <div class="small" style="margin-top:8px">Not: Ä°lk 4 kategoride Tarama/Ä°zlem seÃ§mezsen otomatik â€œÄ°zlemâ€ kaydedilir.</div>
  </div>
</div>

<div id="listTab" style="display:none">
  <div class="panel">
    <div class="grid2">
      <div><input id="fad" placeholder="Ä°sim filtre"></div>
      <div><input id="ftc" placeholder="TC filtre"></div>
    </div>
    <select id="fkat"></select>

    <div class="grid2" style="margin-top:6px">
      <div><button id="clearBtn" type="button" style="background:rgba(255,255,255,.12)">Filtreleri temizle</button></div>
      <div><button id="refreshBtn" type="button" style="background:rgba(255,255,255,.12)">Yenile</button></div>
    </div>

    <div id="list" style="margin-top:10px">YÃ¼kleniyorâ€¦</div>
  </div>
</div>

</body>
  <!-- ÅÄ°FRE KONTROL SCRIPTÄ° -->
<script>
const APP_PASSWORD = "1234"; // ğŸ‘ˆ burayÄ± deÄŸiÅŸtir

function checkPassword(){
  const val = document.getElementById("passwordInput").value;
  if(val === APP_PASSWORD){
    document.getElementById("loginScreen").style.display = "none";
    sessionStorage.setItem("loggedIn","1");
  }else{
    document.getElementById("loginError").style.display = "block";
  }
}

if(sessionStorage.getItem("loggedIn")==="1"){
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("loginScreen").style.display="none";
  });
}
</script>

</body>
<script>
const APP_PASSWORD = "826747"; // ğŸ‘ˆ BURAYI DEÄÄ°ÅTÄ°R

function checkPassword(){
  const val = document.getElementById("passwordInput").value;
  if(val === APP_PASSWORD){
    document.getElementById("loginScreen").style.display = "none";
    sessionStorage.setItem("loggedIn","1");
  }else{
    document.getElementById("loginError").style.display = "block";
  }
}

// sayfa yenilense bile tekrar sormasÄ±n
if(sessionStorage.getItem("loggedIn")==="1"){
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("loginScreen").style.display="none";
  });
}
</script>

</html>
