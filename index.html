<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aile HekimliÄŸi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f3b27">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --forest:#1f3b27;
  --forest2:#0b1f16;
  --panel:#2a4a33;
  --cream:#f5f1e8;
  --cream2:#efe6d8;
  --text:#0b1f16;
  --muted:#607066;
  --accent:#2e7d32;
  --accent2:#4caf50;
  --danger:#b23b3b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:linear-gradient(180deg,var(--forest),var(--forest2));
  color:#fff;
  padding:16px;
}
h1{margin:0 0 10px 0;font-size:22px;letter-spacing:.2px}
.panel{
  background:var(--panel);
  border-radius:22px;
  padding:16px;
  margin:14px 0;
}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:140px}
input,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:var(--cream);
  color:var(--text);
  margin:6px 0;
  font-size:15px;
}
button{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  color:white;
  font-weight:800;
  font-size:16px;
  cursor:pointer;
}
button:active{transform:translateY(1px)}

.chipbar{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}
.hint{font-size:12px;color:rgba(255,255,255,.75)}
.divider{height:1px;background:rgba(255,255,255,.12);margin:10px 0}

.cat-card{
  background:var(--cream2);
  color:var(--text);
  border-radius:18px;
  padding:14px;
  margin-top:10px;
  position:relative;
}
.cat-title{font-weight:900;margin-bottom:6px}
.remove{
  position:absolute;
  top:10px; right:12px;
  cursor:pointer;
  color:var(--danger);
  font-size:18px;
  user-select:none;
}

.list-card{
  background:var(--cream);
  color:var(--text);
  border-radius:20px;
  padding:14px;
  margin-top:12px;
}
.small{font-size:12px;color:var(--muted)}
.btn-danger{
  background:transparent;
  color:var(--danger);
  border:1px solid var(--danger);
  padding:8px 12px;
  border-radius:999px;
  margin-top:8px;
  font-weight:700;
}
.badges{margin-top:8px}
.badge{
  display:inline-block;
  margin:3px 6px 0 0;
  padding:3px 10px;
  border-radius:999px;
  font-size:12px;
  background:rgba(46,125,50,.12);
  border:1px solid rgba(46,125,50,.35);
}
.badge2{
  background:rgba(31,59,39,.08);
  border-color:rgba(31,59,39,.25);
}
.top-actions{
  display:flex;gap:10px;flex-wrap:wrap;
}
.top-actions button{flex:1;min-width:140px}
.btn-secondary{
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.20);
  font-weight:800;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc,
  query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhRWEiA-rrpuazR_YnV7UmhQ-UiDeAHUU",
  authDomain: "aile-hekimligi-paneli.firebaseapp.com",
  projectId: "aile-hekimligi-paneli"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const KATS = [
  "Hipertansiyon","DM","KVR","Obezite",
  "YaÅŸlÄ± Ä°zlem","KAH Ä°zlem","Ä°nme Ä°zlem",
  "KBH Ä°zlem","KOAH Ä°zlem","AstÄ±m Ä°zlem"
];
const ILK4 = new Set(["Hipertansiyon","DM","KVR","Obezite"]);

let selectedCats = []; // [{kategori, alt, hyp}]
let ALL = [];          // tÃ¼m hastalar (firebase)

function $(id){ return document.getElementById(id); }

window.onload = () => {
  // Kategori dropdownâ€™larÄ±nÄ± her aÃ§Ä±lÄ±ÅŸta yeniden kuruyoruz â†’ â€œkategoriler silindiâ€ hissi biter
  const sel = $("katSec");
  sel.innerHTML = `<option value="">Kategori seÃ§</option>` + KATS.map(k=>`<option>${k}</option>`).join("");

  const fsel = $("fkat");
  fsel.innerHTML = `<option value="">Kategori (filtre)</option>` + KATS.map(k=>`<option>${k}</option>`).join("");

  load();
};

window.katEkle = () => {
  const k = $("katSec").value;
  if(!k) return;
  if(selectedCats.some(x => x.kategori === k)) return; // aynÄ± kategori 2 kez eklenmesin
  selectedCats.push({ kategori:k, alt:"", hyp:"" });
  renderSelected();
};

window.kaldir = (idx) => {
  selectedCats.splice(idx, 1);
  renderSelected();
};

function renderSelected(){
  const host = $("cards");
  host.innerHTML = "";
  if(!selectedCats.length){
    host.innerHTML = `<div class="hint">Kategori seÃ§ip â€œ+ Kategori Ekleâ€ deyince kartlar burada Ã§Ä±kacak.</div>`;
    return;
  }

  selectedCats.forEach((x,i) => {
    const needsAlt = ILK4.has(x.kategori);

    host.innerHTML += `
      <div class="cat-card">
        <div class="remove" title="KaldÄ±r" onclick="kaldir(${i})">ğŸ—‘ï¸</div>
        <div class="cat-title">${x.kategori}</div>

        ${needsAlt ? `
          <select onchange="selectedCats[${i}].alt=this.value">
            <option value="">Tarama / Ä°zlem</option>
            <option ${x.alt==="Tarama"?"selected":""}>Tarama</option>
            <option ${x.alt==="Ä°zlem"?"selected":""}>Ä°zlem</option>
          </select>
        ` : ``}

        <input placeholder="HYP tarihi (Ã¶rn: 2025-02-11)"
               value="${x.hyp?.replaceAll('"','&quot;') || ""}"
               oninput="selectedCats[${i}].hyp=this.value">
      </div>
    `;
  });
}

window.ekle = async () => {
  const ad = $("ad").value.trim();
  const tc = $("tc").value.trim();
  if(!ad || !tc) return alert("Ad ve TC zorunlu.");

  if(!selectedCats.length) return alert("En az 1 kategori eklemelisin.");

  // UX: Ä°lk 4â€™te alt kategori boÅŸsa otomatik Ä°zlem yap (uyarÄ± verme, akÄ±ÅŸÄ± bozma)
  const kategoriler = selectedCats.map(x => ({
    kategori: x.kategori,
    alt: ILK4.has(x.kategori) ? (x.alt || "Ä°zlem") : "",
    hyp: (x.hyp || "").trim()
  }));

  await addDoc(collection(db, "patients"), {
    ad, tc, kategoriler,
    createdAt: serverTimestamp()
  });

  // temizle
  $("ad").value = "";
  $("tc").value = "";
  $("katSec").value = "";
  selectedCats = [];
  renderSelected();

  await load();
};

async function load(){
  const q = query(collection(db,"patients"), orderBy("createdAt","desc"));
  const s = await getDocs(q);
  ALL = [];
  s.forEach(d => ALL.push({ id:d.id, ...d.data() }));
  filtre();
}

window.filtre = () => {
  const fa = $("fad").value.trim().toLowerCase();
  const ft = $("ftc").value.trim();
  const fk = $("fkat").value.trim();

  const filtered = ALL.filter(r => {
    const adOk = !fa || (r.ad||"").toLowerCase().includes(fa);
    const tcOk = !ft || (r.tc||"").includes(ft);
    const katOk = !fk || (r.kategoriler||[]).some(k => k.kategori === fk);
    return adOk && tcOk && katOk;
  });

  const list = $("list");
  list.innerHTML = "";

  if(!filtered.length){
    list.innerHTML = `<div class="hint">EÅŸleÅŸen kayÄ±t yok.</div>`;
    return;
  }

  filtered.forEach(r => {
    const badges = (r.kategoriler||[]).map(k => {
      const alt = k.alt ? ` â€¢ ${k.alt}` : "";
      const hyp = k.hyp ? ` â€¢ ${k.hyp}` : "";
      return `<span class="badge">${k.kategori}${alt}${hyp}</span>`;
    }).join("");

    list.innerHTML += `
      <div class="list-card">
        <div style="font-weight:900;font-size:16px">${r.ad}</div>
        <div class="small">TC: ${r.tc}</div>
        <div class="badges">${badges || `<span class="badge badge2">Kategori yok</span>`}</div>
        <button class="btn-danger" onclick="sil('${r.id}')">Sil</button>
      </div>
    `;
  });
};

window.temizle = () => {
  $("fad").value = "";
  $("ftc").value = "";
  $("fkat").value = "";
  filtre();
};

window.sil = async (id) => {
  if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
  await deleteDoc(doc(db, "patients", id));
  await load();
};

// ilk aÃ§Ä±lÄ±ÅŸta kart alanÄ±nÄ± boÅŸ mesajla doldur
window.selectedCats = selectedCats;
</script>
</head>

<body>
  <h1>ğŸŒ² Aile HekimliÄŸi</h1>

  <div class="panel">
    <div class="hint">Hasta kaydÄ±: kategori seÃ§ â†’ ekle â†’ kartlardan doldur â†’ Kaydet</div>

    <div class="row">
      <div class="col"><input id="ad" placeholder="Ad Soyad"></div>
      <div class="col"><input id="tc" placeholder="TC"></div>
    </div>

    <div class="row">
      <div class="col">
        <select id="katSec"></select>
      </div>
      <div class="col">
        <button class="btn-secondary" onclick="katEkle()">+ Kategori Ekle</button>
      </div>
    </div>

    <div id="cards"></div>

    <div class="divider"></div>
    <button onclick="ekle()">Kaydet</button>
  </div>

  <div class="panel">
    <div class="row">
      <div class="col"><input id="fad" placeholder="Ä°sim filtre" oninput="filtre()"></div>
      <div class="col"><input id="ftc" placeholder="TC filtre" oninput="filtre()"></div>
      <div class="col">
        <select id="fkat" onchange="filtre()"></select>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn-secondary" onclick="temizle()">Filtreleri temizle</button>
      <button class="btn-secondary" onclick="load()">Yenile</button>
    </div>

    <div id="list" style="margin-top:10px">YÃ¼kleniyorâ€¦</div>
  </div>

<script>
  // kart alanÄ±na ilk mesaj
  setTimeout(()=>{
    const cards = document.getElementById("cards");
    if(cards && !cards.innerHTML.trim()){
      cards.innerHTML = `<div class="hint">Kategori seÃ§ip â€œ+ Kategori Ekleâ€ deyince kartlar burada Ã§Ä±kacak.</div>`;
    }
  }, 0);
</script>
</body>
</html>
