<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aile HekimliÄŸi Paneli</title>
<meta name="theme-color" content="#0b1f16">

<style>
:root{
  --bg:#0b1f16;
  --panel:#10271c;
  --card:#153424;
  --accent:#4caf50;
  --accent2:#2e7d32;
  --text:#f4fff6;
  --muted:#a7c9b0;
  --danger:#ff6b6b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:radial-gradient(circle at top,#1f3b27 0,#0b1f16 55%,#05120b 100%);
  color:var(--text);
  padding:16px;
}
h1{margin:0 0 6px 0;color:#a5d6a7;font-size:22px}
.small{font-size:12px;color:var(--muted)}
.panel{
  background:var(--panel);
  border-radius:14px;
  padding:14px;
  margin:12px 0;
  border:1px solid rgba(255,255,255,0.06);
}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
input,select,textarea,button{
  width:100%;
  margin:6px 0;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(8,25,16,0.85);
  color:var(--text);
  font-size:14px;
  outline:none;
}
input:focus,select:focus,textarea:focus{
  border-color:rgba(76,175,80,0.9);
  box-shadow:0 0 0 1px rgba(76,175,80,0.5);
}
textarea{min-height:70px;resize:vertical}
button{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none;
  font-weight:700;
  cursor:pointer;
}
button:active{transform:translateY(1px)}
.cat{
  background:rgba(9,26,18,0.9);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;
  padding:10px;
  margin:8px 0;
}
.cat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.cat-title{font-weight:700}
.cat-check{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color:var(--muted);
}
.cat-check input{width:auto;margin:0}
.cat-fields{margin-top:8px;opacity:.55;pointer-events:none}
.cat.active .cat-fields{opacity:1;pointer-events:auto}
.card{
  background:var(--card);
  border-radius:12px;
  padding:10px;
  margin-top:10px;
  border:1px solid rgba(255,255,255,0.06);
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.card-main{min-width:0}
.bullets{margin-top:6px}
.bullets div{margin:2px 0;color:var(--text)}
hr.sep{border:none;border-top:1px solid rgba(255,255,255,0.08);margin:10px 0}
.btn-danger{
  width:auto;
  padding:8px 12px;
  background:rgba(255,107,107,0.14);
  color:#ffd3d3;
  border:1px solid rgba(255,107,107,0.5);
  border-radius:999px;
  font-weight:700;
}
.actions{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  background:rgba(76,175,80,0.18);
  border:1px solid rgba(76,175,80,0.5);
  color:var(--text);
  margin-top:6px;
}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // âœ… Senin config (aynÄ±)
  const firebaseConfig = {
    apiKey: "AIzaSyDhRWEiA-rrpuazR_YnV7UmhQ-UiDeAHUU",
    authDomain: "aile-hekimligi-paneli.firebaseapp.com",
    projectId: "aile-hekimligi-paneli",
    storageBucket: "aile-hekimligi-paneli.firebasestorage.app",
    messagingSenderId: "661070000720",
    appId: "1:661070000720:web:7e657b58ba337f3ef55755"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ILK4 = new Set(["Hipertansiyon","DM","KVR","Obezite"]);
  const KATEGORILER = [
    "Hipertansiyon","DM","KVR","Obezite",
    "YaÅŸlÄ± Ä°zlem","KAH Ä°zlem","Ä°nme Ä°zlem","KBH Ä°zlem","KOAH Ä°zlem","AstÄ±m Ä°zlem"
  ];

  let ALL_ROWS = []; // Firestoreâ€™dan gelen tÃ¼m kayÄ±tlar (id dahil)

  function esc(s){
    return String(s ?? "").replace(/[&<>\"']/g, c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function normalizeKategoriler(r){
    // Yeni model: r.kategoriler (array)
    if(Array.isArray(r.kategoriler)) return r.kategoriler;

    // Eski sade kayÄ±tlar: r.kategori + r.hyp
    if(r.kategori){
      return [{ kategori:r.kategori, altkategori:"", hyp:r.hyp || "" }];
    }
    return [];
  }

  function buildKategoriUI(){
    const host = document.getElementById("kategoriHost");
    host.innerHTML = "";

    KATEGORILER.forEach(name=>{
      const wrap = document.createElement("div");
      wrap.className = "cat";
      wrap.dataset.name = name;

      const head = document.createElement("div");
      head.className = "cat-head";

      const title = document.createElement("div");
      title.className = "cat-title";
      title.textContent = name;

      const checkLabel = document.createElement("label");
      checkLabel.className = "cat-check";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "cat-cb";
      cb.dataset.name = name;

      const txt = document.createElement("span");
      txt.textContent = "Bu kategori var";

      checkLabel.appendChild(cb);
      checkLabel.appendChild(txt);

      head.appendChild(title);
      head.appendChild(checkLabel);

      const fields = document.createElement("div");
      fields.className = "cat-fields";

      const hyp = document.createElement("input");
      hyp.placeholder = "HYP tarihi (Ã¶rn: 2025-02-11)";
      hyp.className = "cat-hyp";
      hyp.dataset.name = name;
      fields.appendChild(hyp);

      if(ILK4.has(name)){
        const sel = document.createElement("select");
        sel.className = "cat-alt";
        sel.dataset.name = name;
        sel.innerHTML = `
          <option value="">Alt kategori (Tarama / Ä°zlem)</option>
          <option value="Tarama">Tarama</option>
          <option value="Ä°zlem">Ä°zlem</option>
        `;
        fields.appendChild(sel);

        const note = document.createElement("div");
        note.className = "small";
        note.textContent = "Bu 4 kategoride Tarama/Ä°zlem seÃ§imi zorunlu.";
        fields.appendChild(note);
      } else {
        const note = document.createElement("div");
        note.className = "small";
        note.textContent = "Bu kategoride Tarama/Ä°zlem yok.";
        fields.appendChild(note);
      }

      wrap.appendChild(head);
      wrap.appendChild(fields);
      host.appendChild(wrap);

      cb.addEventListener("change", ()=>{
        if(cb.checked) wrap.classList.add("active");
        else wrap.classList.remove("active");
      });
    });
  }

  function buildFilterUI(){
    const fKat = document.getElementById("fKategori");
    fKat.innerHTML = `<option value="">Kategori (filtre)</option>` + KATEGORILER.map(k=>`<option>${k}</option>`).join("");

    // filtre deÄŸiÅŸince otomatik uygula
    ["fAd","fTc","fKategori","fAlt"].forEach(id=>{
      document.getElementById(id).addEventListener("input", applyFilters);
      document.getElementById(id).addEventListener("change", applyFilters);
    });
  }

  function applyFilters(){
    const qAd = document.getElementById("fAd").value.trim().toLowerCase();
    const qTc = document.getElementById("fTc").value.trim();
    const qKat = document.getElementById("fKategori").value;
    const qAlt = document.getElementById("fAlt").value;

    let rows = ALL_ROWS.slice();

    if(qAd){
      rows = rows.filter(x => (x.ad || "").toLowerCase().includes(qAd));
    }
    if(qTc){
      rows = rows.filter(x => (x.tc || "").includes(qTc));
    }
    if(qKat){
      rows = rows.filter(x => (x.kategoriler || []).some(k => k.kategori === qKat));
    }
    if(qAlt){
      rows = rows.filter(x => (x.kategoriler || []).some(k => (k.altkategori || "") === qAlt));
    }

    renderList(rows);
  }

  function renderList(rows){
    const list = document.getElementById("list");

    if(!rows.length){
      list.innerHTML = "<div class='small'>Filtreye gÃ¶re kayÄ±t bulunamadÄ±.</div>";
      return;
    }

    list.innerHTML = "";
    rows.forEach(r=>{
      const card = document.createElement("div");
      card.className = "card";

      const main = document.createElement("div");
      main.className = "card-main";

      const bullets = (r.kategoriler || []).map(k=>{
        let line = k.kategori || "";
        if(k.altkategori) line += " â€“ " + k.altkategori;
        if(k.hyp) line += " â€“ HYP: " + k.hyp;
        return `<div>â€¢ ${esc(line)}</div>`;
      }).join("");

      main.innerHTML = `
        <b>${esc(r.ad)}</b><br>
        <span class="small">TC: ${esc(r.tc || "")}</span>
        <div class="bullets">${bullets || "<div class='small'>Kategori yok</div>"}</div>
        ${r.not ? `<hr class="sep"><div class="small">${esc(r.not)}</div>` : ""}
      `;

      const actions = document.createElement("div");
      actions.className = "actions";
      actions.innerHTML = `<button class="btn-danger" onclick="sil('${r._id}')">Sil</button>`;

      card.appendChild(main);
      card.appendChild(actions);
      list.appendChild(card);
    });

    // kÃ¼Ã§Ã¼k sayÄ±m
    const count = document.getElementById("countPill");
    count.textContent = `${rows.length} kayÄ±t`;
  }

  async function refreshFromFirestore(){
    document.getElementById("list").innerHTML = "YÃ¼kleniyor...";
    document.getElementById("countPill").textContent = "â€¦";

    const q = query(collection(db, "patients"), orderBy("createdAt","desc"));
    const snap = await getDocs(q);

    const arr = [];
    snap.forEach(d=>{
      const r = d.data() || {};
      arr.push({
        _id: d.id,
        ad: r.ad || "",
        tc: r.tc || "",
        not: r.not || "",
        createdAt: r.createdAt || null,
        kategoriler: normalizeKategoriler(r)
      });
    });

    ALL_ROWS = arr;
    applyFilters();
  }

  async function ekle(){
    const ad = document.getElementById("ad").value.trim();
    const tc = document.getElementById("tc").value.trim();
    const not = document.getElementById("not").value.trim();

    if(!ad || !tc){
      alert("Ad ve TC zorunlu.");
      return;
    }

    const selected = [];
    document.querySelectorAll(".cat-cb").forEach(cb=>{
      if(cb.checked){
        const name = cb.dataset.name;
        const hyp = (document.querySelector(`.cat-hyp[data-name="${CSS.escape(name)}"]`)?.value || "").trim();
        const altEl = document.querySelector(`.cat-alt[data-name="${CSS.escape(name)}"]`);
        const alt = altEl ? altEl.value : "";

        if(ILK4.has(name) && !alt){
          throw new Error(name + " iÃ§in Tarama/Ä°zlem seÃ§melisin.");
        }

        selected.push({ kategori:name, altkategori:alt, hyp:hyp });
      }
    });

    if(!selected.length){
      alert("En az bir kategori seÃ§melisin.");
      return;
    }

    try{
      await addDoc(collection(db, "patients"), {
        ad, tc,
        kategoriler: selected,
        not,
        createdAt: new Date()
      });
    }catch(e){
      alert(e?.message || "KayÄ±t eklenemedi.");
      return;
    }

    // temizle
    document.getElementById("ad").value = "";
    document.getElementById("tc").value = "";
    document.getElementById("not").value = "";
    document.querySelectorAll(".cat-cb").forEach(cb=>{ cb.checked=false; });
    document.querySelectorAll(".cat").forEach(c=> c.classList.remove("active"));
    document.querySelectorAll(".cat-hyp").forEach(i=> i.value="");
    document.querySelectorAll(".cat-alt").forEach(s=> s.value="");

    await refreshFromFirestore();
  }

  async function sil(id){
    if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
    await deleteDoc(doc(db, "patients", id));
    await refreshFromFirestore();
  }

  function filtreTemizle(){
    document.getElementById("fAd").value = "";
    document.getElementById("fTc").value = "";
    document.getElementById("fKategori").value = "";
    document.getElementById("fAlt").value = "";
    applyFilters();
  }

  // HTML onclick iÃ§in global
  window.ekle = ekle;
  window.sil = sil;
  window.filtreTemizle = filtreTemizle;

  window.addEventListener("load", async ()=>{
    buildKategoriUI();
    buildFilterUI();
    await refreshFromFirestore();
  });
</script>
</head>

<body>
  <h1>ðŸŒ² Aile HekimliÄŸi Paneli</h1>
  <div class="small">Bu tur: Filtreleme + Silme (Firebase senkron âœ…)</div>

  <div class="panel">
    <div class="row">
      <div class="col"><input id="ad" placeholder="Ad Soyad"></div>
      <div class="col"><input id="tc" placeholder="TC"></div>
    </div>

    <div class="small" style="margin-top:6px;">Kategorileri iÅŸaretle (birden fazla seÃ§ebilirsin):</div>
    <div id="kategoriHost"></div>

    <textarea id="not" placeholder="Genel notlar (opsiyonel)"></textarea>
    <button onclick="ekle()">Kaydet</button>
    <div class="small">Not: Ä°lk 4 kategoride (HT, DM, KVR, Obezite) Tarama/Ä°zlem zorunlu.</div>
  </div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <div class="small">KayÄ±tlar</div>
      <div id="countPill" class="pill">â€¦</div>
    </div>

    <div class="row">
      <div class="col"><input id="fAd" placeholder="Ä°simde ara"></div>
      <div class="col"><input id="fTc" placeholder="TC'de ara"></div>
    </div>

    <div class="row">
      <div class="col">
        <select id="fKategori">
          <option value="">Kategori (filtre)</option>
        </select>
      </div>
      <div class="col">
        <select id="fAlt">
          <option value="">Alt kategori (Tarama/Ä°zlem)</option>
          <option value="Tarama">Tarama</option>
          <option value="Ä°zlem">Ä°zlem</option>
        </select>
      </div>
    </div>

    <button onclick="filtreTemizle()" style="margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.12)">Filtreleri temizle</button>

    <div id="list">YÃ¼kleniyor...</div>
  </div>

  <div class="small" style="margin-top:10px;">
    Mini gÃ¼venlik notu: Bu veri artÄ±k bulutta. Bir sonraki adÄ±mda Firestore kurallarÄ±nÄ± sadece sana Ã¶zel kilitleyelim. ðŸ”’
  </div>
</body>
</html>
